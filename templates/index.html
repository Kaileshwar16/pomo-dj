<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pomodoro App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Finger+Paint&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <!-- YouTube Background -->
  <div id="video-container">
    <iframe id="ytPlayer" src="" frameborder="0" allowfullscreen></iframe>
  </div>

  <!-- Foreground UI -->
  <div id="content">
    <button id="settingsBtn" onclick="toggleSettings()">⚙️</button>
    <h1>Pomodoro App</h1>

    <!-- Timer Display -->
    <div id="timerSection">
      <h2 id="sessionLabel">Study Session</h2>
      <div id="timer">25:00</div>
      <button onclick="startTimer()">Start</button>
      <button onclick="pauseTimer()">Pause</button>
      <button onclick="resetTimer()">Reset</button>
      <button id="focusToggleBtn" onclick="toggleFocusMode()">Focus Mode</button>
    </div>
  </div>

  <!-- Settings Dialog -->
  <div id="settingsDialog">
    <label>Study (mins):
      <input type="number" id="studyTime" value="25" />
    </label>
    <label>Short Break:
      <input type="number" id="shortBreak" value="5" />
    </label>
    <label>Long Break:
      <input type="number" id="longBreak" value="15" />
    </label>
    <label>YouTube Background URL:
      <input type="text" id="ytLink" placeholder="Enter YouTube URL" />
    </label>
    <button onclick="applySettings(); updateVideo(); toggleSettings();">Apply & Close</button>
  </div>

  <script>
    let timer = 25 * 60;
    let timerDuration = 25 * 60;
    let interval;
    let isStudy = true;
    let cycleCount = 0;

    function updateVideo() {
      const url = document.getElementById('ytLink').value;
      const videoId = url.split('v=')[1]?.split('&')[0];
      if (!videoId) return alert('Invalid YouTube URL');
      document.getElementById('ytPlayer').src =
        `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0&modestbranding=1`;
    }

    function updateDisplay() {
      const min = Math.floor(timer / 60);
      const sec = timer % 60;
      document.getElementById('timer').innerText =
        `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function applySettings() {
      const study = parseInt(document.getElementById('studyTime').value) || 25;
      timerDuration = study * 60;
      timer = timerDuration;
      isStudy = true;
      cycleCount = 0;
      document.getElementById("sessionLabel").innerText = "Study Session";
      updateDisplay();
    }

    function toggleSettings() {
      const dialog = document.getElementById('settingsDialog');
      dialog.style.display = dialog.style.display === 'none' || dialog.style.display === '' ? 'block' : 'none';
    }

    function startTimer() {
      if (interval) return;
      interval = setInterval(() => {
        if (timer <= 0) {
          clearInterval(interval);
          interval = null;
          handleSessionEnd();
          return;
        }
        timer--;
        updateDisplay();
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(interval);
      interval = null;
    }

    function resetTimer() {
      pauseTimer();
      timer = timerDuration;
      updateDisplay();
    }

    function toggleFocusMode() {
      document.body.classList.toggle("focus-mode")
    }

    function handleSessionEnd() {
      if (isStudy) {
        cycleCount++;
        if (cycleCount % 4 === 0) {
          timer = (parseInt(document.getElementById('longBreak').value) || 15) * 60;
          document.getElementById("sessionLabel").innerText = "Long Break";
          alert("Long break time!");
        } else {
          timer = (parseInt(document.getElementById('shortBreak').value) || 5) * 60;
          document.getElementById("sessionLabel").innerText = "Short Break";
          alert("Short break time!");
        }
      } else {
        timer = (parseInt(document.getElementById('studyTime').value) || 25) * 60;
        document.getElementById("sessionLabel").innerText = "Study Session";
        alert("Back to study!");
      }
      isStudy = !isStudy;
      updateDisplay();
    }

    window.onload = updateDisplay;
  </script>
</body>
</html>
